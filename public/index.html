<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mini Snapshot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; max-width: 760px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    button { padding: 8px 14px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .muted { color: #666; font-size: 12px; }
  </style>
  <script type="module">
    import { BrowserProvider, getAddress, ethers, parseUnits } from "https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.min.js";

    const api = (path, opts={}) => fetch(path, { headers: { "Content-Type": "application/json" }, ...opts });

    let account, chainId, verifier;
    let proposal;
    const VOTE_VERIFIER = "0xB8A99CdD8269648939e0e0512b2f30961673D9BA"
    const ASSET_ADDR     = "0x4A3f041065a05879c0427ebFce059d73a6A664EA";      // Asset.sol ERC20
    const VAULT_ADDR     = "0x689801367256cf9752d26E7C9F8cd39dbd9c2aCB";      // LiquidStakingVault.sol
    const PUBLISHER_ADDR = "0x26D7B1e30bAA1d77cFE27221BfbB79F7462FFa0F";  // GovernanceRootPublisher.sol

    const ERC20_ABI = [
      "function decimals() view returns (uint8)",
      "function allowance(address owner, address spender) view returns (uint256)",
      "function approve(address spender, uint256 value) returns (bool)",
      "function mint() public",
      "function getAsset() public"
    ];

    const VAULT_ABI = [
      "function deposit(uint256 assets) returns (uint256)"
    ];

    const PUBLISHER_ABI = [
      "function owner() view returns (address)",
      "function createProposal(bytes32 actionDataHash, uint64 votingStart, uint64 votingEnd) returns (uint256)"
    ];

    let deadline;
    async function loadProposal() {
      const id = document.getElementById("proposalId").value || "1";
      const res = await api(`/api/proposal/${id}`);
      const data = await res.json();
      if (!res.ok) { alert(data.error || "Failed to load proposal"); return; }
      proposal = data;
      chainId = data.chainB.chainId;
      verifier = data.chainB.verifier;
      deadline = data.deadline;

      document.getElementById("details").innerHTML = `
        <div>Proposal ID: <b>${data.proposalId}</b></div>
        <div>Snapshot Block: <b>${data.snapshotBlock}</b></div>
        <div>Snapshot ER: <b>${data.snapshotER}</b></div>
        <div>Voting Start: <b>${new Date(data.votingStart*1000).toLocaleString()}</b></div>
        <div>Voting End: <b>${new Date(data.votingEnd*1000).toLocaleString()}</b></div>
        <div>Deadline: <b>${new Date(data.deadline*1000).toLocaleString()}</b></div>
        <div class="muted">Verifier (Chain B): <b>${data.chainB.verifier}</b> on chainId <b>${data.chainB.chainId}</b></div>
      `;
    }

    async function connect() {
      if (!window.ethereum) { alert("Install MetaMask"); return; }
      const provider = new BrowserProvider(window.ethereum);
      const accs = await provider.send("eth_requestAccounts", []);
      account = getAddress(accs[0]);
      document.getElementById("acct").textContent = account;
    }
    async function connectIfNeeded() {
      if (!window.ethereum) throw new Error("Install MetaMask");
      const provider = new BrowserProvider(window.ethereum);
      const [acc] = await provider.send("eth_requestAccounts", []);
      account = getAddress(acc);
      return { provider, signer: await provider.getSigner() };
    }

    function eip712Domain(chainId, verifyingContract) {
      return { name: "CrossGov", version: "1", chainId, verifyingContract };
    }

    function eip712Types() {
      return {
        Vote: [
          { name: "proposalId", type: "uint256" },
          { name: "support",    type: "bool"    },
          { name: "voter",      type: "address" },
          { name: "power",      type: "uint256" },
          { name: "nonce",      type: "uint256" },
          { name: "deadline",   type: "uint256" },
        ]
      };
    }

    async function signAndSubmitVote() {
      if (!account) return alert("Connect wallet first");
      if (!proposal) return alert("Load proposal first");

      const supportSel = document.querySelector('input[name="support"]:checked');
      if (!supportSel) return alert("Choose Yes/No/Abstain");

      const abstain = supportSel.value === "abstain";
      const support = supportSel.value === "yes" ? true : false;

      const { nextNonce } = await (await fetch(`/api/nextNonce/${proposal.proposalId}/${account}`)).json();
      const nonce = BigInt(nextNonce);

      const power_resp = await fetch('/api/compute-power/', {
            method: "POST",
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              proposalId: proposal.proposalId,
              voter: account,
      }),
      })
      const power_data = await power_resp.json()
      // console.log("P O W E R", power_data);      
      const value = {
        proposalId: BigInt(proposal.proposalId),
        support,
        voter: account,
        power: power_data.power,
        nonce,
        deadline,
      };

      console.log("value", value);
      

      const provider = new BrowserProvider(window.ethereum);
      const signer = await provider.getSigner();

      const signature = await signer.signTypedData(
        eip712Domain(proposal.chainB.chainId, VOTE_VERIFIER),
        eip712Types(),
        value
      );

      const resp = await api("/api/vote", {
        method: "POST",
        body: JSON.stringify({
          proposalId: proposal.proposalId,
          support,
          abstain,
          voter: account,
          userPower: power_data.power,
          nonce: nonce.toString(),
          deadline: deadline.toString(),
          signature
        })
      });
      const data = await resp.json();
      if (!resp.ok) alert(data.error || "Vote failed");
      else alert("Vote stored ✅");
    }

    async function claimAsset() {
      try {
        if (!window.ethereum) return alert("Install MetaMask");
        if (!account) return alert("Connect wallet first");

      const provider = new BrowserProvider(window.ethereum);
      const signer = await provider.getSigner();

      const contract = new ethers.Contract(ASSET_ADDR, ERC20_ABI, signer);

      const tx = await contract.getAsset();
      alert(`Tx sent: ${tx.hash}`);
      const rcpt = await tx.wait();
      alert(`Claimed Successfully}`);
    } catch (err) {
      console.error(err);
      alert(err?.message || "Claim failed");
    }
  }


    async function createMerkle() {
        if (!proposal) return alert("Load proposal first");

        // 1) Freeze (build & store root)
        let resp = await api(`/api/merkle/${proposal.proposalId}`, { method: "POST" });
        let data = await resp.json();
        if (!resp.ok) return alert(data.error || "Freeze failed");
        alert(`Root frozen ✅\nRoot: ${data.root}\nTotal counted: ${data.counts.totalCounted}`);

        // 2) Build multiproof for ALL voters
        resp = await api(`/api/multiproof/${proposal.proposalId}`, { method: "POST", body: JSON.stringify({}) });
        data = await resp.json();
        if (!resp.ok) return alert(data.error || "Multiproof failed");

        alert(`Multiproof ready.\nLeaves: ${data.leaves.length}\nProof nodes: ${data.proof.length}\nFlags: ${data.proofFlags.length}`);
    }

      async function depositToVault() {
        try {
          if (!account) return alert("Connect wallet first");
          const amtStr = document.getElementById("depositAmt").value.trim();
          if (!amtStr) return alert("Enter amount");
          const provider = new BrowserProvider(window.ethereum);
          const signer   = await provider.getSigner();
          const asset  = new ethers.Contract(ASSET_ADDR, ERC20_ABI, signer);
          const vault  = new ethers.Contract(VAULT_ADDR, VAULT_ABI, signer);
          // assume 18 decimals
          // const dec = await asset.decimals();
          const dec = 18;
          const amount = parseUnits(amtStr, dec);
          const current = await new ethers.Contract(ASSET_ADDR, ERC20_ABI, provider).allowance(account, VAULT_ADDR);
          if (current < amount) {
            const txA = await asset.approve(VAULT_ADDR, amount);
            await txA.wait();
          }

          // deposit
          const tx = await vault.deposit(amount);
          await tx.wait();
          alert("Deposit successful ✅");
        } catch (e) {
          console.error(e);
          alert(`Deposit failed: ${e?.message || e}`);
        }
      }

      async function createProposalSimple() {
  try {
    const { provider, signer } = await connectIfNeeded();
    const publisher = new ethers.Contract(PUBLISHER_ADDR, PUBLISHER_ABI, signer);

    // read inputs
    const actionHash = document.getElementById("cp_actionHash").value.trim();
    const startStr   = document.getElementById("cp_start").value.trim();
    const endStr     = document.getElementById("cp_end").value.trim();

    // basic validation
    if (!/^0x[0-9a-fA-F]{64}$/.test(actionHash)) {
      return alert("actionDataHash must be a 32-byte 0x hex string");
    }
    if (!/^\d+$/.test(startStr) || !/^\d+$/.test(endStr)) {
      return alert("votingStart / votingEnd must be unix seconds (numbers)");
    }

    const votingStart = BigInt(startStr);
    const votingEnd   = BigInt(endStr);
    if (votingEnd <= votingStart) {
      return alert("votingEnd must be greater than votingStart");
    }

    // // optional: enforce onlyOwner UX
    // const owner = await publisher.owner();
    // if (getAddress(owner) !== getAddress(account)) {
    //   return alert(`Connected account is not the publisher owner.\nOwner: ${owner}`);
    // }

    // Simulate to get the returned proposalId
    const predictedId = await publisher.createProposal.staticCall(actionHash, votingStart, votingEnd);

    const tx = await publisher.createProposal(actionHash, votingStart, votingEnd);
    const rc = await tx.wait();
      alert(`Proposal created ✅
PROPOSAL_ID: ${predictedId.toString()}
Tx: ${tx.hash}`);
  } catch (e) {
    console.error(e);
    alert(e?.reason || e?.message || String(e));
  }
}



    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("btnLoad").onclick = loadProposal;
      document.getElementById("btnConnect").onclick = connect;
      document.getElementById("btnVote").onclick = signAndSubmitVote;
      document.getElementById("btnMerkle").onclick = createMerkle;
      document.getElementById("btnClaim").onclick = claimAsset;
      document.getElementById("btnDeposit").onclick = depositToVault;
      document.getElementById("cp_btn").onclick = createProposalSimple;

    });
  </script>
</head>
<body>
  <div class="card">
  <h3>Claim ASSET</h3>
  <p class="muted">Calls <code>getAsset()</code> on Chain A to transfer you 100 ASSET (requires gas).</p>
  <button id="btnClaim">Claim 100 ASSET</button>
</div>
  <div class="card">
  <h3>Deposit into LST Vault</h3>
  <div class="row">
    <input id="depositAmt" placeholder="Amount (e.g. 100)" />
    <button id="btnDeposit">Approve & Deposit</button>
  </div>
  <div class="muted">Uses ASSET.approve → vault.deposit(amount). Assumes 18 decimals.</div>
</div>
<div class="card">
  <h3>Create Proposal (unix seconds)</h3>
  <div style="display:flex; flex-direction:column; gap:8px;">
    <input id="cp_actionHash" placeholder="actionDataHash (0x…32 bytes)" />
    <input id="cp_start" placeholder="votingStart (unix seconds)" />
    <input id="cp_end" placeholder="votingEnd (unix seconds)" />
    <button id="cp_btn">Create Proposal</button>
  </div>
  <div class="muted">Requires publisher owner. Example: start=1760790000, end=1760876400.</div>
</div>
  <div class="card">
    <div class="row">
      <input id="proposalId" placeholder="Proposal ID" value="1" />
      <button id="btnLoad">Load Proposal</button>
      <button id="btnConnect">Connect Wallet</button>
      <div id="acct" class="muted"></div>
    </div>
  </div>

  <div class="card">
    <h3>Proposal Details</h3>
    <div id="details" class="muted">Load a proposal...</div>
  </div>



  <div class="card">
    <h3>Cast Vote (gasless EIP-712)</h3>
    <div>
      <label><input type="radio" name="support" value="yes" /> Yes</label>
      <label><input type="radio" name="support" value="no" /> No</label>
      <label><input type="radio" name="support" value="abstain" /> Abstain</label>
    </div>
    <div class="row" style="margin-top:12px;">
      <button id="btnVote">Sign & Submit</button>
    </div>
    <div class="muted">Your wallet signs a typed message; the server recomputes power at the snapshot and stores the vote.</div>
  </div>

  <div class="card">
    <h3>Create Merkle Root</h3>
    <button id="btnMerkle">Create Merkle Root</button>
    <div class="muted">Creates the root which can be submitted on chain</div>
  </div>
</body>
</html>
